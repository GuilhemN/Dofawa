<?php

namespace Dof\ItemsBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * ItemSetRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ItemSetRepository extends EntityRepository
{
    public function findOneWithJoins($criteria = array()){
        $qb = $this->queryWithJoins($criteria);

		return $qb
        	->getQuery()
        	->getSingleResult()
		;
    }

    public function findWithJoins($criteria = array()){
        $qb = $this->queryWithJoins($criteria);

		return $qb
        	->getQuery()
        	->getResult()
		;
    }

    protected function queryWithJoins($criteria){
        $criteria = (array) $criteria;

        $qb = $this
                  ->createQueryBuilder('s')
				  ->select(array('s', 'i', 'c', 're', 'rei'))
                  ->join('s.items', 'i')
                  ->join('s.combinations', 'c')
                  ->leftjoin('i.components', 're')
                  ->leftjoin('re.component', 'rei')
                  ->orderBy('c.itemCount', 'asc')
              ;

		$i = 0;
		foreach($criteria as $k => $v){
			$i++;
			$qb
				->andWhere('s.' . $k . ' LIKE :filterWord' . $i)
				->setParameter('filterWord' . $i, $v)
			;
		}

        return $qb;
    }
}
